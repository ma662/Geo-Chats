<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge"> -->
    <title>Geo-Chats Login Page</title>
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <!-- <script src="main.js"></script> -->
</head>
<body>

    <div id="input-div">
        <form id="input-form">
            <label>Username: </label><input id="username" type="text">
            <label>Password: </label><input id="pass" type="password">
        </form>
    </div>
    
</body>

    <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase.js"></script>
    <script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyDs156FXHEVnRk6yj6Z82K8nWY3w1YJiG0",
        authDomain: "geo-chats.firebaseapp.com",
        databaseURL: "https://geo-chats.firebaseio.com",
        projectId: "geo-chats",
        storageBucket: "geo-chats.appspot.com",
        messagingSenderId: "157534175404"
    };
    firebase.initializeApp(config);

    var database = firebase.database();
    var userRef = database.ref("users/");

    var debugVar = null;

    // PRESENTATION NOTES: 
        // technologeis
        // problems we saw
        // problems we still have 
        // future enhancements
        // things that are still incomplete

    // append input-div to body, input-form to input-div
    // $("<div>").attr("id", "input-div").appendTo(document.body);
    $("<form>").attr("id", "input-form").appendTo($("#input-div"));
    $("#username").prop("required", true);
    $('#pass').prop("required", true);

    // append sign-up, login buttons
    $("<button>").text("Login").attr("id", "login").appendTo("#input-form");
    $("<button>").text("Sign Up").attr("id", "sign-up").appendTo($("#input-form"));

    $("#sign-up").on("click", function(e) {
        e.preventDefault();

        // _confFlag = true;

        $("<label>").text(" Confirm Password: ").appendTo("#input-form");
        var confPass = $("<input type='password'>").attr("id", "conf-pass").prop("required", true).appendTo("#input-form");

        $("<button id='sign-up-for-real'>").text("Sign Up For Real").appendTo("#input-form");

        // so focus automatically goes to new button
        $("#login").remove();
        $("#sign-up").remove();

        $("#sign-up-for-real").on("click", function(e) {
            e.preventDefault();

            var uName = $("#username").val().trim();
            var uPass = $("#pass").val().trim();
            var confPass = $("#conf-pass").val().trim();
            // var request = "sign-up"; 

            var _newUserFlag = false; // is user clear for signup?

            var imgArr = []; // array of images to be randomly selected for db pushing

            // do a database check and execute code within the event
            userRef.once("value")
            .then(function(snapshot) {
                debugVar = snapshot;

                if (snapshot.hasChild(uName)) {
                    console.log("user tried to sign-up with taken username");
                    _newUserFlag = false;
                    
                    // how do i reload page
                } 
                else {
                    _newUserFlag = true;
                }

                // if user is cleared for signup 
                if (_newUserFlag) {
                    // uPass and confPass are good
                    if (uPass === confPass) {
                        database.ref("users/" + uName + "/").set({
                            username: uName,
                            pass: uPass,
                            // image : image link
                        });

                        alert("Your account was successfully created!");
                        location.reload();
                    } 
                    else {
                        alert("Your passwords don't match");
                    }
                }
                else {
                    alert("That username is taken");
                }
            });

            // clear boxes
            $("#username").val('');
            $("#pass").val('');
            $("#conf-pass").val('');

        }); // end #sign-up-for-real 

    }); // end #sign-up

    $("#login").on("click", function(e) {
        e.preventDefault();

        // get vals of uName and uPass
        var uName = $("#username").val().trim();
        var uPass = $("#pass").val().trim();

        // alert(uName + "\n" + uPass);

        if (uName != '') {
            userRef.once("value")
                .then(function(snapshot) {
                    debugVar = snapshot;
                    mySnap = snapshot.val();

                    // if db doesn't have uName
                    if (!snapshot.hasChild(uName)){
                        alert("Either this username password combination is incorrect or that user doesn't exist.");

                        // for (var i=0; i<Object.keys(mySnap).length; i++) {
                        //     var thisKey = Object.keys(mySnap)[i];

                        //     var vals = Object.keys(mySnap[thisKey]);
                        //     console.log(vals);

                        //     var dPass = mySnap[thisKey];

                    }
                    else {
                        // if db does have it, pull snapshot data, see if uPass matches pass of db user
                        var comp = mySnap[uName]['pass'];
                        console.log(comp);

                        if (uPass === comp) {
                            // Clear sessionStorage
                            sessionStorage.clear();

                            // Store all content into sessionStorage
                            sessionStorage.setItem("username", uName);

                            alert("Login successful");

                            window.open("./index.html"); // open main page
                        }
                        else {
                            alert("Either this username password combination is incorrect or that user doesn't exist.");
                        }

                    }
                    $("#username").val('');
                    $("#pass").val('');
            });
        }
    });
</script>
</html>